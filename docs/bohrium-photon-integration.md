# ç»å°”å¹³å°å…‰å­æ‰£è´¹é›†æˆæŒ‡å—

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•åœ¨ Figsci é¡¹ç›®ä¸­é…ç½®å’Œä½¿ç”¨ç»å°”å¹³å°çš„å…‰å­æ‰£è´¹åŠŸèƒ½ã€‚

## ç›®å½•

- [1. ä»€ä¹ˆæ˜¯å…‰å­](#1-ä»€ä¹ˆæ˜¯å…‰å­)
- [2. å‰ç½®æ¡ä»¶](#2-å‰ç½®æ¡ä»¶)
- [3. é…ç½®æ­¥éª¤](#3-é…ç½®æ­¥éª¤)
- [4. ä½¿ç”¨æ–¹å¼](#4-ä½¿ç”¨æ–¹å¼)
- [5. æ‰£è´¹è§„åˆ™](#5-æ‰£è´¹è§„åˆ™)
- [6. å¼€å‘è°ƒè¯•](#6-å¼€å‘è°ƒè¯•)
- [7. å¸¸è§é—®é¢˜](#7-å¸¸è§é—®é¢˜)
- [8. æŠ€æœ¯å®ç°](#8-æŠ€æœ¯å®ç°)

## 1. ä»€ä¹ˆæ˜¯å…‰å­

**å…‰å­ï¼ˆPhotonï¼‰** æ˜¯ç»å°”å¹³å°çš„è™šæ‹Ÿè´§å¸ã€‚

- **ç”¨æˆ·**ï¼šå¯ä»¥é€šè¿‡å‚ä¸æ´»åŠ¨ã€å……å€¼ç­‰æ–¹å¼è·å–å…‰å­
- **å¼€å‘è€…**ï¼šå¯ä»¥é€šè¿‡å¼€å‘ç»å°” Appsï¼Œå‘ç”¨æˆ·æ”¶å–å…‰å­

### ç›¸å…³é“¾æ¥

- **å…‰å­å……å€¼å…¥å£**ï¼šhttps://www.bohrium.com/consume?tab=topUpPhoton&menu=balance
- **å…‰å­è´¦å•å…¥å£**ï¼šhttps://www.bohrium.com/consume?tab=photon&menu=bills
- **å¼€å‘è€…æ–‡æ¡£**ï¼šhttps://dptechnology.feishu.cn/wiki/LQKKwMet7i70XNk3TcjcwH8jnJi

## 2. å‰ç½®æ¡ä»¶

åœ¨é›†æˆå…‰å­æ‰£è´¹åŠŸèƒ½ä¹‹å‰ï¼Œéœ€è¦å®Œæˆä»¥ä¸‹å‡†å¤‡å·¥ä½œï¼š

### 2.1 ç”³è¯· SKU ID

æ¯ä¸ª App éœ€è¦æœ‰å”¯ä¸€å¯¹åº”çš„ `skuId`ï¼Œè¯·é€šè¿‡ä»¥ä¸‹é“¾æ¥ç”³è¯·ï¼š

**ç”³è¯·åœ°å€**ï¼šhttps://dptechnology.feishu.cn/share/base/form/shrcnpCtBXBYZNWmwiNDMdGPH5c

### 2.2 è·å–å¼€å‘è€… Access Keyï¼ˆç”¨äºå¼€å‘è°ƒè¯•ï¼‰

åœ¨å¼€å‘è°ƒè¯•é˜¶æ®µï¼Œå¯ä»¥ä½¿ç”¨å¼€å‘è€…è‡ªå·±çš„ AK è¿›è¡Œæµ‹è¯•ï¼š

1. è®¿é—® https://www.bohrium.com/settings/user
2. åœ¨é¡µé¢ä¸­æ‰¾åˆ°å¹¶å¤åˆ¶ä½ çš„ Access Key

**æ³¨æ„**ï¼šè¿™åªç”¨äºå¼€å‘è°ƒè¯•ï¼Œç”Ÿäº§ç¯å¢ƒåº”è¯¥é€šè¿‡ OAuth è·å–ç”¨æˆ· AKã€‚

### 2.3 å¯ç”¨ OAuth èƒ½åŠ›

åœ¨ç»å°”å¹³å°çš„ App ç®¡ç†ç•Œé¢ï¼Œåˆ›å»ºæ–°ç‰ˆæœ¬æ—¶ï¼š

1. é€‰æ‹©æ‰“å¼€ **OAuth èƒ½åŠ›**
2. ç”¨æˆ·æ‰“å¼€ App æ—¶ï¼Œä¼šè¦æ±‚ç”¨æˆ·æˆæƒç™»å½•
3. ç”¨æˆ·æˆæƒåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†ç”¨æˆ·çš„ AK ä¿¡æ¯å­˜å‚¨åœ¨ Cookie ä¸­

## 3. é…ç½®æ­¥éª¤

### 3.1 å¤åˆ¶ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶

```bash
cp env.example .env.local
```

### 3.2 é…ç½®ç¯å¢ƒå˜é‡

åœ¨ `.env.local` æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```env
# ===== ç»å°”å¹³å°å…‰å­æ‰£è´¹é…ç½® =====

# 1. å¯ç”¨å…‰å­æ‰£è´¹åŠŸèƒ½
NEXT_PUBLIC_ENABLE_PHOTON_CHARGE=true

# 2. é…ç½® SKU IDï¼ˆä»ç”³è¯·è¡¨è·å–ï¼‰
BOHRIUM_SKU_ID=your-sku-id-here

# 3. é…ç½®å¼€å‘è€… Access Keyï¼ˆä»…ç”¨äºå¼€å‘è°ƒè¯•ï¼‰
BOHRIUM_DEV_ACCESS_KEY=your-access-key-here

# 4. é…ç½® Client Nameï¼ˆå¯é€‰ï¼‰
BOHRIUM_CLIENT_NAME=your-client-name-here

# 5. é€‰æ‹©æ‰£è´¹æ¨¡å¼
# 'fixed' - æ¯æ¬¡è¯·æ±‚å›ºå®šæ‰£è´¹ï¼ˆæ¨èï¼‰
# 'token' - æ ¹æ® token ä½¿ç”¨é‡æ‰£è´¹
BOHRIUM_CHARGE_MODE=fixed

# 6. é…ç½®æ‰£è´¹é‡‘é¢
# å›ºå®šæ‰£è´¹æ¨¡å¼ï¼šæ¯æ¬¡è¯·æ±‚æ‰£é™¤çš„å…‰å­æ•°é‡
BOHRIUM_CHARGE_PER_REQUEST=1

# Token æ‰£è´¹æ¨¡å¼ï¼šæ¯ 1000 ä¸ª token æ‰£é™¤çš„å…‰å­æ•°é‡
BOHRIUM_CHARGE_PER_1K_TOKEN=1
```

### 3.3 é‡å¯åº”ç”¨

```bash
# å¼€å‘æ¨¡å¼
pnpm dev

# ç”Ÿäº§æ¨¡å¼
pnpm build
pnpm start
```

## 4. ä½¿ç”¨æ–¹å¼

### 4.1 è‡ªåŠ¨æ‰£è´¹ï¼ˆæ¨èï¼‰

é…ç½®å®Œæˆåï¼Œç³»ç»Ÿä¼šåœ¨æ¯æ¬¡ AI ç”Ÿæˆå›¾è¡¨æ—¶**è‡ªåŠ¨æ‰£è´¹**ï¼Œæ— éœ€é¢å¤–ä»£ç ï¼š

1. ç”¨æˆ·å‘é€æ¶ˆæ¯è¯·æ±‚ç”Ÿæˆå›¾è¡¨
2. AI æ¨¡å‹ç”Ÿæˆå›¾è¡¨å†…å®¹
3. ç”Ÿæˆå®Œæˆåï¼Œç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨å…‰å­æ‰£è´¹ API
4. æ‰£è´¹æˆåŠŸæˆ–å¤±è´¥çš„æ—¥å¿—ä¼šåœ¨æœåŠ¡å™¨æ§åˆ¶å°è¾“å‡º

**æ³¨æ„**ï¼šæ‰£è´¹å¤±è´¥ä¸ä¼šå½±å“å›¾è¡¨ç”Ÿæˆï¼Œåªä¼šè®°å½•é”™è¯¯æ—¥å¿—ã€‚

### 4.2 æ‰‹åŠ¨æ‰£è´¹ï¼ˆé«˜çº§ç”¨æ³•ï¼‰

å¦‚æœéœ€è¦åœ¨ç‰¹å®šåœºæ™¯æ‰‹åŠ¨è°ƒç”¨æ‰£è´¹ï¼Œå¯ä»¥ä½¿ç”¨æä¾›çš„å®¢æˆ·ç«¯å·¥å…·ï¼š

```javascript
import { chargePhoton } from '@/lib/photon-client';

// æ‰£é™¤æŒ‡å®šæ•°é‡çš„å…‰å­
try {
  const result = await chargePhoton(10, {
    scene: 'appCustomizeCharge', // å¯é€‰ï¼Œé»˜è®¤å€¼
    bizNo: 123456789 // å¯é€‰ï¼Œä¸æä¾›åˆ™è‡ªåŠ¨ç”Ÿæˆ
  });
  
  console.log('æ‰£è´¹æˆåŠŸï¼š', result);
  // result: { success: true, message: "æ‰£è´¹æˆåŠŸ", bizNo: 123456789, eventValue: 10 }
} catch (error) {
  console.error('æ‰£è´¹å¤±è´¥ï¼š', error);
}
```

## 5. æ‰£è´¹è§„åˆ™

### 5.1 å›ºå®šæ‰£è´¹æ¨¡å¼ï¼ˆæ¨èï¼‰

æ¯æ¬¡ AI ç”Ÿæˆè¯·æ±‚æ‰£é™¤å›ºå®šæ•°é‡çš„å…‰å­ï¼Œé€‚ç”¨äºå¤§å¤šæ•°åœºæ™¯ã€‚

**é…ç½®**ï¼š
```env
BOHRIUM_CHARGE_MODE=fixed
BOHRIUM_CHARGE_PER_REQUEST=1  # æ¯æ¬¡è¯·æ±‚æ‰£é™¤ 1 å…‰å­
```

**é€‚ç”¨åœºæ™¯**ï¼š
- ç®€å•ã€æ˜“ç†è§£çš„è®¡è´¹æ–¹å¼
- ç”¨æˆ·ä½“éªŒæ›´å¥½ï¼ˆå›ºå®šä»·æ ¼ï¼‰
- é€‚åˆåŠŸèƒ½å‹åº”ç”¨

### 5.2 Token æ‰£è´¹æ¨¡å¼

æ ¹æ®å®é™…æ¶ˆè€—çš„ token æ•°é‡æ‰£è´¹ï¼Œæ›´å…¬å¹³ä½†è®¡è´¹é€»è¾‘æ›´å¤æ‚ã€‚

**é…ç½®**ï¼š
```env
BOHRIUM_CHARGE_MODE=token
BOHRIUM_CHARGE_PER_1K_TOKEN=1  # æ¯ 1000 ä¸ª token æ‰£é™¤ 1 å…‰å­
```

**è®¡è´¹å…¬å¼**ï¼š
```
æ‰£è´¹é‡‘é¢ = ceil((æ€» token æ•° / 1000) Ã— æ¯åƒ token è´¹ç”¨)
```

**é€‚ç”¨åœºæ™¯**ï¼š
- éœ€è¦æ›´ç²¾ç¡®çš„æˆæœ¬æ§åˆ¶
- ç”¨æˆ·è¯·æ±‚å¤æ‚åº¦å·®å¼‚è¾ƒå¤§
- é€‚åˆä¼ä¸šçº§åº”ç”¨

### 5.3 æ‰£è´¹ç¤ºä¾‹

#### å›ºå®šæ‰£è´¹ç¤ºä¾‹

```
ç”¨æˆ· Aï¼šç”Ÿæˆç®€å•æµç¨‹å›¾ï¼ˆ200 tokensï¼‰ â†’ æ‰£é™¤ 1 å…‰å­
ç”¨æˆ· Bï¼šç”Ÿæˆå¤æ‚æ¶æ„å›¾ï¼ˆ5000 tokensï¼‰ â†’ æ‰£é™¤ 1 å…‰å­
```

#### Token æ‰£è´¹ç¤ºä¾‹ï¼ˆå‡è®¾ 1 å…‰å­/1000 tokensï¼‰

```
ç”¨æˆ· Aï¼šç”Ÿæˆç®€å•æµç¨‹å›¾ï¼ˆ200 tokensï¼‰ â†’ æ‰£é™¤ 1 å…‰å­ï¼ˆå‘ä¸Šå–æ•´ï¼‰
ç”¨æˆ· Bï¼šç”Ÿæˆå¤æ‚æ¶æ„å›¾ï¼ˆ5000 tokensï¼‰ â†’ æ‰£é™¤ 5 å…‰å­
```

## 6. å¼€å‘è°ƒè¯•

### 6.1 æœ¬åœ°è°ƒè¯•æµç¨‹

1. **é…ç½®å¼€å‘è€… AK**
   ```env
   BOHRIUM_DEV_ACCESS_KEY=your-access-key-here
   ```

2. **å¯ç”¨æ‰£è´¹åŠŸèƒ½**
   ```env
   NEXT_PUBLIC_ENABLE_PHOTON_CHARGE=true
   ```

3. **æµ‹è¯•æ‰£è´¹**
   - å¯åŠ¨åº”ç”¨ï¼š`pnpm dev`
   - å‘é€æ¶ˆæ¯ç”Ÿæˆå›¾è¡¨
   - æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼š
     ```
     å‘èµ·å…‰å­æ‰£è´¹è¯·æ±‚ï¼š { bizNo: xxx, eventValue: 1, ... }
     å…‰å­æ‰£è´¹æˆåŠŸï¼š { bizNo: xxx, eventValue: 1 }
     ```

### 6.2 æµ‹è¯•ä¸åŒæ‰£è´¹æ¨¡å¼

#### æµ‹è¯•å›ºå®šæ‰£è´¹

```env
BOHRIUM_CHARGE_MODE=fixed
BOHRIUM_CHARGE_PER_REQUEST=5
```

æ¯æ¬¡è¯·æ±‚æ‰£é™¤ 5 å…‰å­ã€‚

#### æµ‹è¯• Token æ‰£è´¹

```env
BOHRIUM_CHARGE_MODE=token
BOHRIUM_CHARGE_PER_1K_TOKEN=2
```

æ ¹æ®å®é™… token ä½¿ç”¨é‡æ‰£è´¹ï¼ˆæ¯ 1000 token æ‰£é™¤ 2 å…‰å­ï¼‰ã€‚

### 6.3 æ¨¡æ‹Ÿç”¨æˆ·æ‰£è´¹

è¦æ¨¡æ‹ŸçœŸå®ç”¨æˆ·æ‰£è´¹ï¼ˆè€Œä¸æ˜¯ä½¿ç”¨å¼€å‘è€… AKï¼‰ï¼Œéœ€è¦ï¼š

1. åœ¨ç»å°”å¹³å°åˆ›å»ºæµ‹è¯•ç”¨æˆ·
2. ä¸ºæµ‹è¯•ç”¨æˆ·å……å€¼å…‰å­
3. ä½¿ç”¨æµ‹è¯•ç”¨æˆ·è´¦å·ç™»å½•å¹¶æˆæƒ
4. Cookie ä¸­ä¼šåŒ…å«ç”¨æˆ·çš„ AK
5. æ‰£è´¹ä¼šä»æµ‹è¯•ç”¨æˆ·è´¦æˆ·æ‰£é™¤

## 7. å¸¸è§é—®é¢˜

### Q1: æ‰£è´¹å¤±è´¥ä¼šå½±å“åŠŸèƒ½å—ï¼Ÿ

**ç­”**ï¼šä¸ä¼šã€‚æ‰£è´¹å¤±è´¥åªä¼šè®°å½•é”™è¯¯æ—¥å¿—ï¼Œä¸ä¼šä¸­æ–­å›¾è¡¨ç”Ÿæˆæµç¨‹ã€‚è¿™æ˜¯ä¸ºäº†ç¡®ä¿ç”¨æˆ·ä½“éªŒï¼Œå³ä½¿æ‰£è´¹ç³»ç»Ÿå‡ºç°é—®é¢˜ï¼Œç”¨æˆ·ä»ç„¶å¯ä»¥æ­£å¸¸ä½¿ç”¨åŠŸèƒ½ã€‚

### Q2: å¦‚ä½•æŸ¥çœ‹æ‰£è´¹è®°å½•ï¼Ÿ

**ç­”**ï¼š
- **ç”¨æˆ·ç«¯**ï¼šhttps://www.bohrium.com/consume?tab=photon&menu=bills
- **å¼€å‘è€…ç«¯**ï¼šhttps://www.bohrium.com/developer/financial-management

### Q3: å¼€å‘è°ƒè¯•æ—¶ä¼šçœŸå®æ‰£è´¹å—ï¼Ÿ

**ç­”**ï¼šæ˜¯çš„ã€‚ä½¿ç”¨å¼€å‘è€… AK æ—¶ï¼Œæ‰£è´¹ä¼šä»å¼€å‘è€…è´¦æˆ·çœŸå®æ‰£é™¤ã€‚å»ºè®®ï¼š
1. åœ¨å¼€å‘é˜¶æ®µè®¾ç½®è¾ƒå°çš„æ‰£è´¹é‡‘é¢
2. æˆ–è€…æš‚æ—¶å…³é—­æ‰£è´¹åŠŸèƒ½ï¼š`NEXT_PUBLIC_ENABLE_PHOTON_CHARGE=false`

### Q4: å¦‚ä½•å¤„ç†ç”¨æˆ·å…‰å­ä½™é¢ä¸è¶³ï¼Ÿ

**ç­”**ï¼šæ‰£è´¹ API ä¼šè¿”å›é”™è¯¯ç  403ï¼Œä½ å¯ä»¥åœ¨å‰ç«¯æ•è·è¿™ä¸ªé”™è¯¯å¹¶æç¤ºç”¨æˆ·å……å€¼ã€‚å½“å‰å®ç°ä¸­ï¼Œæ‰£è´¹å¤±è´¥ä¸ä¼šå½±å“åŠŸèƒ½ä½¿ç”¨ï¼Œåªä¼šè®°å½•æ—¥å¿—ã€‚

### Q5: OAuth æˆæƒå¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**ç­”**ï¼š
1. ç¡®ä¿åœ¨ç»å°”å¹³å° App ç®¡ç†ç•Œé¢å¯ç”¨äº† OAuth èƒ½åŠ›
2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ­£ç¡®æˆæƒ
3. æŸ¥çœ‹æµè§ˆå™¨ Cookie ä¸­æ˜¯å¦åŒ…å« `appAccessKey`

### Q6: å¦‚ä½•è‡ªå®šä¹‰æ‰£è´¹é€»è¾‘ï¼Ÿ

**ç­”**ï¼šç¼–è¾‘ `app/api/chat/route.js` ä¸­çš„ `chargePhotonIfEnabled` å‡½æ•°ï¼Œå¯ä»¥å®ç°ï¼š
- ä¸åŒåœºæ™¯ä¸åŒæ‰£è´¹é‡‘é¢
- æ ¹æ®ç”¨æˆ·ç­‰çº§è°ƒæ•´æ‰£è´¹
- å…è´¹é¢åº¦æ”¯æŒ
- ç­‰ç­‰

## 8. æŠ€æœ¯å®ç°

### 8.1 æ¶æ„è®¾è®¡

```
ç”¨æˆ·è¯·æ±‚
   â†“
èŠå¤© API (/api/chat)
   â†“
AI æ¨¡å‹ç”Ÿæˆå›¾è¡¨
   â†“
onFinish å›è°ƒ â†’ chargePhotonIfEnabled()
   â†“
å…‰å­æ‰£è´¹ API (/api/photon/charge)
   â†“
ç»å°”å¹³å°æ‰£è´¹æ¥å£
```

### 8.2 æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `app/api/photon/charge/route.js` | å…‰å­æ‰£è´¹ API è·¯ç”± |
| `lib/photon-client.js` | å…‰å­æ‰£è´¹å®¢æˆ·ç«¯å·¥å…·åº“ |
| `app/api/chat/route.js` | èŠå¤© APIï¼ˆé›†æˆäº†è‡ªåŠ¨æ‰£è´¹ï¼‰ |

### 8.3 æ‰£è´¹æµç¨‹

#### æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Chat as èŠå¤© API
    participant AI as AI æ¨¡å‹
    participant Charge as å…‰å­æ‰£è´¹
    participant Bohrium as ç»å°”å¹³å°

    User->>Chat: å‘é€æ¶ˆæ¯
    Chat->>AI: è°ƒç”¨ AI ç”Ÿæˆå›¾è¡¨
    AI-->>Chat: è¿”å›å›¾è¡¨ + token ä½¿ç”¨é‡
    Chat->>Charge: è°ƒç”¨æ‰£è´¹å‡½æ•°
    Charge->>Bohrium: POST /api/integral/consume
    Bohrium-->>Charge: è¿”å›æ‰£è´¹ç»“æœ
    Charge-->>Chat: è®°å½•æ—¥å¿—
    Chat-->>User: è¿”å›ç”Ÿæˆçš„å›¾è¡¨
```

#### è¯¦ç»†æ­¥éª¤

1. **ç”¨æˆ·å‘é€è¯·æ±‚**
   - ç”¨æˆ·åœ¨èŠå¤©ç•Œé¢å‘é€æ¶ˆæ¯
   - è¯·æ±‚å‘é€åˆ° `/api/chat`

2. **AI æ¨¡å‹ç”Ÿæˆå†…å®¹**
   - èŠå¤© API è°ƒç”¨ AI æ¨¡å‹
   - æ¨¡å‹ç”Ÿæˆå›¾è¡¨å†…å®¹
   - è®°å½• token ä½¿ç”¨é‡

3. **è‡ªåŠ¨è§¦å‘æ‰£è´¹**
   - åœ¨ `onFinish` å›è°ƒä¸­è°ƒç”¨ `chargePhotonIfEnabled()`
   - æ£€æŸ¥æ˜¯å¦å¯ç”¨æ‰£è´¹åŠŸèƒ½
   - è·å–ç”¨æˆ· AKï¼ˆä» Cookie æˆ–ä½¿ç”¨å¼€å‘è€… AKï¼‰

4. **è°ƒç”¨æ‰£è´¹ API**
   - è®¡ç®—æ‰£è´¹é‡‘é¢ï¼ˆæ ¹æ®é…ç½®çš„æ¨¡å¼ï¼‰
   - ç”Ÿæˆå”¯ä¸€çš„ `bizNo`
   - è°ƒç”¨ç»å°”å¹³å°æ‰£è´¹æ¥å£

5. **å¤„ç†æ‰£è´¹ç»“æœ**
   - æˆåŠŸï¼šè®°å½•æ—¥å¿—
   - å¤±è´¥ï¼šè®°å½•é”™è¯¯ï¼Œä½†ä¸å½±å“ä¸»æµç¨‹

### 8.4 å…³é”®ä»£ç ç‰‡æ®µ

#### è‡ªåŠ¨æ‰£è´¹å‡½æ•°

```javascript
// app/api/chat/route.js

async function chargePhotonIfEnabled(req, usage) {
  const enablePhotonCharge = process.env.NEXT_PUBLIC_ENABLE_PHOTON_CHARGE === 'true';
  
  if (!enablePhotonCharge) {
    return;
  }
  
  // è®¡ç®—æ‰£è´¹é‡‘é¢
  const chargeMode = process.env.BOHRIUM_CHARGE_MODE || 'fixed';
  let eventValue = 0;
  
  if (chargeMode === 'token') {
    const chargePerKToken = parseFloat(process.env.BOHRIUM_CHARGE_PER_1K_TOKEN || '1');
    eventValue = Math.ceil((usage.totalTokens / 1000) * chargePerKToken);
  } else {
    eventValue = parseInt(process.env.BOHRIUM_CHARGE_PER_REQUEST || '1');
  }
  
  // è°ƒç”¨æ‰£è´¹ API...
}
```

#### é›†æˆåˆ°èŠå¤© API

```javascript
// app/api/chat/route.js

const result = await streamText(commonConfig);

return result.toUIMessageStreamResponse({
  onFinish: async ({ responseMessage, messages: messages2 }) => {
    // è®°å½• token ä½¿ç”¨é‡
    const usage = await result.usage;
    
    // è‡ªåŠ¨æ‰£è´¹
    await chargePhotonIfEnabled(req, {
      inputTokens: usage.inputTokens,
      outputTokens: usage.outputTokens,
      totalTokens: usage.totalTokens
    });
  }
});
```

## 9. åˆè§„æ€§è€ƒé‡

æ ¹æ®ç»å°”å¹³å°çš„è¦æ±‚ï¼Œå¼€å‘è€…éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

### 9.1 å‘ç”¨æˆ·æ¸…æ™°å‘ŠçŸ¥æ”¶è´¹ä¿¡æ¯

åœ¨ App ä¸­ä»»ä½•å¯èƒ½å‘ç”¨æˆ·æ”¶è´¹çš„ä½ç½®ï¼Œåº”è¯¥ï¼š

1. **æ¸…æ™°å±•ç¤ºæ”¶è´¹é‡‘é¢**
   - å‘ŠçŸ¥ç”¨æˆ·æ¯æ¬¡æ“ä½œéœ€è¦å¤šå°‘å…‰å­
   - å»ºè®®åœ¨ UI ä¸­æ·»åŠ è´¹ç”¨æç¤º

2. **è¯´æ˜æ”¶è´¹è§„åˆ™**
   - ä»€ä¹ˆæƒ…å†µä¸‹ä¼šæ‰£è´¹
   - æ‰£è´¹é‡‘é¢å¦‚ä½•è®¡ç®—

ç¤ºä¾‹å®ç°ï¼š
```jsx
// åœ¨èŠå¤©ç•Œé¢æ·»åŠ è´¹ç”¨æç¤º
<div className="charge-notice">
  ğŸ’° æ¯æ¬¡ç”Ÿæˆå›¾è¡¨éœ€è¦ {chargeAmount} å…‰å­
</div>
```

### 9.2 ç»´æŠ¤æ‰£è´¹è®°å½•

å¼€å‘è€…åº”è¯¥ç»´æŠ¤ä¸€ä»½æ•°æ®è®°å½•ï¼Œä¾¿äºåç»­æ ¸å¯¹ï¼š

```javascript
// ç¤ºä¾‹ï¼šè®°å½•æ‰£è´¹æ—¥å¿—åˆ°æ•°æ®åº“
async function logChargeRecord(userId, bizNo, eventValue, result) {
  await database.chargeRecords.create({
    userId: userId,
    bizNo: bizNo,
    amount: eventValue,
    success: result.success,
    timestamp: new Date(),
    details: result
  });
}
```

### 9.3 æŸ¥çœ‹å…‰å­æ”¶å…¥

å¼€å‘è€…å¯ä»¥åœ¨å¼€å‘è€…åå°æŸ¥çœ‹å…‰å­æ”¶å…¥ï¼š

**å…¥å£**ï¼šhttps://www.bohrium.com/developer/financial-management

**æ³¨æ„**ï¼šåªæœ‰ 2025 å¹´ 10 æœˆ 15 æ—¥ä¹‹åçš„è‡ªå®šä¹‰ SKU è®¢å•æ‰ä¼šè¢«ç»Ÿè®¡ã€‚

## 10. å‚è€ƒèµ„æº

- **ç»å°”å¹³å°å¼€å‘è€…æ–‡æ¡£**ï¼šhttps://dptechnology.feishu.cn/wiki/LQKKwMet7i70XNk3TcjcwH8jnJi
- **SKU ID ç”³è¯·è¡¨**ï¼šhttps://dptechnology.feishu.cn/share/base/form/shrcnpCtBXBYZNWmwiNDMdGPH5c
- **ä¸ªäººè®¾ç½®ï¼ˆè·å– AKï¼‰**ï¼šhttps://www.bohrium.com/settings/user
- **å…‰å­å……å€¼**ï¼šhttps://www.bohrium.com/consume?tab=topUpPhoton&menu=balance
- **å…‰å­è´¦å•**ï¼šhttps://www.bohrium.com/consume?tab=photon&menu=bills
- **å¼€å‘è€…è´¢åŠ¡ç®¡ç†**ï¼šhttps://www.bohrium.com/developer/financial-management

---

å¦‚æœ‰é—®é¢˜ï¼Œè¯·åœ¨ GitHub ä¸Šæ Issue æˆ–å‚è€ƒç»å°”å¹³å°å®˜æ–¹æ–‡æ¡£ã€‚
