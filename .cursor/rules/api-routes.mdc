---
globs: app/api/**/*.js
description: Next.js API 路由最佳实践和规范
---

# Next.js API 路由规范

## 文件结构

所有 API 路由文件应遵循以下结构：

```javascript
// 1. 导入语句（带注释说明用途）
import { ... } from "...";

// 2. 配置常量
const maxDuration = 60; // Next.js Route Handler 的最长执行时间（秒）

// 3. 路由处理函数（带 JSDoc 注释）
/**
 * HTTP_METHOD /api/route
 * 功能描述
 */
async function METHOD(req) {
  try {
    // 处理逻辑
  } catch (error) {
    // 错误处理
  }
}

// 4. 导出
export { METHOD, maxDuration };
```

## 错误处理

### 1. 统一错误处理函数
```javascript
// 将底层错误翻译成更友好的中文提示，便于前端直接展示
let errorHandler = function(error) {
  // 处理各种错误类型，返回用户友好的中文消息
};
```

### 2. HTTP 状态码
- `400`: 客户端请求错误（缺少必需参数、格式错误等）
- `401`: 未授权（API Key 无效）
- `403`: 权限不足
- `404`: 资源未找到
- `500`: 服务器内部错误

### 3. 错误响应格式
```javascript
return Response.json(
  {
    error: "错误类型",
    message: "详细错误信息（中文）",
    ...(process.env.NODE_ENV === 'development' && { details: error.stack })
  },
  { status: 500 }
);
```

## 请求验证

始终验证请求参数：

```javascript
const { param1, param2 } = await req.json();

if (!param1) {
  return Response.json(
    { error: "缺少必需参数 param1" },
    { status: 400 }
  );
}
```

## 流式响应

对于需要流式返回的场景（如 AI 生成），使用 AI SDK：

```javascript
import { streamText, createUIMessageStreamResponse } from "ai";

const result = await streamText({
  model: resolvedModel.model,
  messages: enhancedMessages,
  // ... 其他配置
});

return result.toUIMessageStreamResponse({
  onError: errorHandler,
  onFinish: async ({ responseMessage }) => {
    // 处理完成后的逻辑（如记录 token 使用量）
  }
});
```

## 主要 API 端点

### 核心功能 API

- **POST /api/chat** - 图表生成（主要 API）
  - 支持流式响应（SSE）
  - 支持文本和图片输入
  - 集成光子扣费功能
  - 参考：[app/api/chat/route.js](mdc:app/api/chat/route.js)

- **POST /api/diagram-repair** - 图表修复
  - 修复不完整的 draw.io XML
  - 参考：[app/api/diagram-repair/route.js](mdc:app/api/diagram-repair/route.js)

- **POST /api/model-compare** - 模型对比
  - 并排对比多个模型的生成结果
  - 参考：[app/api/model-compare/route.js](mdc:app/api/model-compare/route.js)

### 模板相关 API

- **POST /api/template-match** - 智能模板匹配
  - 使用 AI Agents 匹配最合适的模板
  - 参考：[app/api/template-match/route.js](mdc:app/api/template-match/route.js)
  - 详细说明：[.cursor/rules/ai-agents-workflow.mdc](mdc:.cursor/rules/ai-agents-workflow.mdc)

- **POST /api/search-template** - 模板搜索
  - 根据查询内容搜索匹配的模板
  - 参考：[app/api/search-template/route.js](mdc:app/api/search-template/route.js)

### 模型管理 API

- **GET /api/models** - 获取模型列表
  - 从 LLM 提供商获取可用模型列表
  - 参考：[app/api/models/route.js](mdc:app/api/models/route.js)

- **GET /api/system-models** - 获取系统内置模型列表
  - 返回系统预配置的模型（不包含敏感信息）
  - 参考：[app/api/system-models/route.js](mdc:app/api/system-models/route.js)

- **POST /api/configs** - 配置管理
  - 管理模型配置信息
  - 参考：[app/api/configs/route.js](mdc:app/api/configs/route.js)

### 光子扣费 API

- **POST /api/photon/charge** - 光子扣费
  - 执行光子扣费操作
  - 支持固定扣费和按 Token 扣费
  - 参考：[app/api/photon/charge/route.js](mdc:app/api/photon/charge/route.js)
  - 详细文档：[docs/bohrium-photon-integration.md](mdc:docs/bohrium-photon-integration.md)

- **POST /api/photon/pre-charge** - 预扣费检查
  - 检查是否需要扣费及扣费金额
  - 参考：[app/api/photon/pre-charge/route.js](mdc:app/api/photon/pre-charge/route.js)

### 认证 API

- **POST /api/auth/validate** - 认证验证
  - 验证访问密码等认证信息
  - 参考：[app/api/auth/validate/route.js](mdc:app/api/auth/validate/route.js)

## 参考实现

参考 [app/api/chat/route.js](mdc:app/api/chat/route.js) 作为标准实现示例。
